# Data release #

Scripts in this repo are used for releasing data generated at OICR to stakeholders.
`dare.py` is used for data release of FASTQ and analysis files generated by pipeline and workflows and recorded in the File Provenance report (FPR). 

## Linking out files with dare.py ##

Links files in GSI space in directories under `/.mounts/labs/gsiprojects/gsi/Data_Transfer/Release/PROJECTS`

usage: ```python dare.py link -l LIBRARIES -w WORKFLOW -n PROJECT_NAME -p PROJECTS_DIR -pr PROJECT -r RUNS --exclude_miseq -rn RUN_NAME -e EXCLUDE -s SUFFIX -f FILES```

Parameters

| argument | purpose | required/optional                                    |
| ------- | ------- | ------------------------------------------ |
| -w | Workflow used to generate the files   | required              |
| -n | Project name | required              |
| -p | Project directory   | required              |
| -s | Suffix appended to the run folder name | required              |
| -l | Path to file with samples to be released   | optional                |
| -pr | Project name indicated in FPR  | optional              |
| -r runs | Single or white space-separated run IDs  | optional              |
| --exclude_miseq | Excludes MiSeq runs | optional              |
| -rn | Requires the regex pattern to match the entire read sequence | optional              |
| -e | Path to file with samples/libraries to be excluded or single or multiple white space separated samples/libraries | optional              |
| -f | Path to file with file names/paths to be released | optional              |


- workflow `-w/ --workflow`:
Required parameter. Workflow name.
The accepted value is bcl2fastq for when releasing FASTQs. This will pull out FASTQs generated by bcl2fastq and CASAVA workflows from FPR.
Workflow name is case-incensitive. For instance, using bamMergePreprocessing will pull out bams generated by workflows BamMergePreprocessing and bamMergePreprocessing.

- project name `-n/ --name`:
Required parameter. The name of the project directory containing the run folders with symlinks in GSI space.
This parameter is used to name the project directory and can be different from the project as it appears in FPR.

- project directory `-p/ --parent`: 
Required parameter with default value `/.mounts/labs/gsiprojects/gsi/Data_Transfer/Release/PROJECTS`
Parent directory containing project directories with links to released files. This parameter does not need to be specified and the default value should not be modified.

- suffix `-s/ --suffix`:
Required parameter.
The recommended value is `fastqs` for FASTQs release and a workflow name or data type for analysis files.
This parameter appends the suffix to the run folder name containing the file links. 

- project `-pr/ --project`:
Optional parameter. The name of the project as it appears in FPR.
Using a project name parameter will only retrieve all records corresponding to  this project.
If only project name is used and run IDs are not provided and a library list is not included, then all files for that project will be linked out in GSI space in corresponding run folders.
Project and run parameters are both optional and project and/or run IDs can be provided. However, a value is expected for at least one of these two parameters, both parameters cannot be omitted. 

- runs `-r/ --runs`:
Optional parameter. Accepts one or more white space-separated run IDs.
Using the run IDs will retrieve all files sequenced during these runs from the FPR. Note that using only the run IDs may pull data from distinct projects.
Use the project parameter to restrict files from a given project from these runs if the runs contain data from multiple projects.
Further restrict the files that should be released using the library parameter if some files need to be withheld.

- libraries `-l/ --libraries` :
Optional parameter. Libraries approved for release.
Tab-delimited file with 1 or 2 columns with library IDs. Library aliases in the 1st column are required, and library aliquot IDs in the second column are optional

| TGL17_0009_Ct_T_PE_307_CM | LDI32439   |
| TGL49_0079_Ov_P_PE_354_TS | LDI37539  |
| TGL55_0001_Pl_n_PE_499_CM | LDI46554  |

| AIX_0221_Ct_T_PE_82201_WG |
| AIX_0232_Ct_T_PE_82210_WG |
| AIX_0224_Ct_T_PE_82225_WG |

- exclude `-e/ --exclude`:
Optional parameter. A file with samples or libraries to be excluded from the release or a single or multiple white space-separated samples or libraries.
This option is used to explicitly withhold files from being released. Links will be generated to a run folder directory with withhold suffix.

- run name `-rn/ --run_name`:
Optional parameter. Sets the name of the folder containing the file links.
If this parameter is omitted then files pulled from FPR are linked out to folders named after their run IDs.
This option is used to replace the run folder ID by a different name. However, using this parameter will link all the files in a single directory specified by the run name parameter. 

- exclude MiSeq runs `--exclude_miseq`:
Use this flag if MiSeq runs are excluded from the release. 
If the flag is not activated then files sequenced on the MiSeq corresponding to a given project and library list will be included.


## Mapping files to external IDs with dare.py ##

Create a table file referencing internal IDs with external IDs privided by stakeholders.

usage: ```python dare.py map -l LIBRARIES -w WORKFLOW -n PROJECT_NAME -p PROJECTS_DIR -pr PROJECT -r RUNS --exclude_miseq -rn RUN_NAME -e EXCLUDE -s SUFFIX -f FILES```

Parameters are the same as described above

Parameters

| argument | purpose | required/optional                                    |
| ------- | ------- | ------------------------------------------ |
| -w | Workflow used to generate the files   | required              |
| -n | Project name | required              |
| -p | Project directory   | required              |
| -s | Suffix appended to the run folder name | required              |
| -l | Path to file with samples to be released   | optional                |
| -pr | Project name indicated in FPR  | optional              |
| -r runs | Single or white space-separated run IDs  | optional              |
| --exclude_miseq | Excludes MiSeq runs | optional              |
| -rn | Requires the regex pattern to match the entire read sequence | optional              |
| -e | Path to file with samples/libraries to be excluded or single or multiple white space separated samples/libraries | optional              |
| -f | Path to file with file names/paths to be released | optional              |


## Marking files in Nabu with dare.py ##

Tag released files in Nabu.

usage: ```python dare.py mark -u USER -rl pass -d DIRECTORY -c COMMENT```

Parameters

| argument | purpose | required/optional                                    |
| ------- | ------- | ------------------------------------------ |
| -u | Name of user handling the data release   | required              |
| -rl | Mark files fail or pass | required              |
| -d | Directory with file links | required              |
| -c | Comment used to tag the file | optional              |

Parameters

- user `-u/ --user`:
Required parameter. Workflow name.
Name of the analyst handling the data release.

- directory `-d/ --directory`:
Required parameter.  Directory with symlinks

- file tag `-rl/ --release`: 
Required parameter. Accepted values `pass` or `fail`.
Marks files released files with `pass` and withheld files with `fail`

- comment `-c/ --comment`: 
Optional parameter. Tag released file with the Jira ticket.


## Transferring files through ociwire ##

Transfers files in `run_directory` through ociwire to UHN.

```bash transfer_out_ociwire.sh run_directory```

## Uploading files to the transfer server ##

Uploads files in directory `run_directory` to the transfer server.

```
tar -cvzhf NAMEORTAR.tar.gz run_directory
bash copy_to_transfer.sh NAMEOFTAR.tar.gz 
```

